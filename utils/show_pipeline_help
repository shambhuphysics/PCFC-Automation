#!/bin/bash -l
#===============================================================================
# Function      : show_pipeline_help
# Purpose       : Display complete coexistence + TI workflow pipeline and utility tools information
# Child Function: --
# Default parameters: section=all
# Run individually: show_pipeline_help [section]
# Last Update   : 2025-07-14
#===============================================================================
show_pipeline_help() {
    local section="${1:-all}"
    
    case "$section" in
        "flow"|"pipeline"|"all")
            echo "üî¨ PHASE COEXISTENCE + FREE ENERGY CORRECTION (PCFC) PIPELINE"
            echo "====================================="
            echo ""
            echo "üìä COMPLETE WORKFLOW SEQUENCE:"
            echo "  0Ô∏è‚É£  main_exe             ‚Üí Coexistence search (binary search algorithm)"
            echo "  1Ô∏è‚É£  calc_vp_scan        ‚Üí Generate volume-pressure data"
            echo "  2Ô∏è‚É£  fit_eos_coex        ‚Üí Fit EOS & find coexistence volumes"
            echo "  3Ô∏è‚É£  sample_md_coex      ‚Üí MD sampling at coexistence conditions"
            echo "  4Ô∏è‚É£  sample_ti_configs   ‚Üí Sample configurations for TI calculations"
            echo ""
            echo "üîÑ COMPLETE DATA FLOW:"
            echo "  POSCAR.coex ‚Üí coex_results.dat ‚Üí POSCAR.s ‚Üí VP.dat ‚Üí vols.tmp ‚Üí XDATCAR.s/l ‚Üí TI directories"
            echo ""
            echo "üèóÔ∏è  COEXISTENCE SEARCH HIERARCHY:"
            echo "  main_exe (Main coexistence function)"
            echo "  ‚îú‚îÄ‚îÄ binary_search_coexistence"
            echo "  ‚îÇ   ‚îî‚îÄ‚îÄ run_coexistence"
            echo "  ‚îÇ       ‚îú‚îÄ‚îÄ run_md"
            echo "  ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ write_incar"
            echo "  ‚îÇ       ‚îú‚îÄ‚îÄ calc_pressure"
            echo "  ‚îÇ       ‚îú‚îÄ‚îÄ density_profile"
            echo "  ‚îÇ       ‚îú‚îÄ‚îÄ check_coexistence"
            echo "  ‚îÇ       ‚îî‚îÄ‚îÄ calc_volume"
            echo "  ‚îú‚îÄ‚îÄ calc_volume (for final results)"
            echo "  ‚îî‚îÄ‚îÄ inline AWK (for pressure extraction)"
            echo ""
            echo "üõ†Ô∏è  UTILITY TOOLS (optional):"
            echo "  üìÑ convert_xdatcar      ‚Üí Convert trajectories to VASP format"
            echo "  üìà calc_msd             ‚Üí Analyze diffusion properties"
            echo "  üîß run_md               ‚Üí Execute MD simulations with cleanup"
            echo "  üìä calc_pressure        ‚Üí Extract pressure from OUTCAR files"
            echo "  üìù write_incar          ‚Üí Generate INCAR parameter files"
            echo "  ‚úÖ check_files          ‚Üí Validate required input files"
            echo "  üèóÔ∏è  prep_structure       ‚Üí Prepare and modify POSCAR files"
            echo "  üìÅ setup_dirs           ‚Üí Create workflow directories"
            echo "  üìã analyze_results      ‚Üí Parse and summarize outputs"
            echo ""
            echo "üöÄ PIPELINE EXECUTION MODES:"
            echo "  ./pipeline.sh coex      ‚Üí Run coexistence search only"
            echo "  ./pipeline.sh ti        ‚Üí Run TI pipeline only (requires coex_results.dat)"
            echo "     ‚îî‚îÄ‚îÄ TI_MODE          ‚Üí DFT | EAM | EAM-DFT |"

            echo "  ./pipeline.sh both      ‚Üí Run complete pipeline (default)"
            echo ""
            [[ "$section" == "all" ]] && echo "üí° Use: show_pipeline_help [function_name] for detailed usage"
            ;;
        
        "main_exe"|"coexistence")
            echo "0Ô∏è‚É£  main_exe - Coexistence Search (Binary Search Algorithm)"
            echo "========================================================"
            echo "Purpose: Find solid-liquid coexistence temperature using binary search"
            echo "Usage:   main_exe (run from Coexistence/ directory)"
            echo "Method:  Binary search algorithm with temperature tolerance"
            echo "Inputs:  POSCAR.coex (coexistence structure)"
            echo "Outputs: coex_results.dat (T, P, V), OUTCAR_*K files"
            echo "Child Functions:"
            echo "  ‚îú‚îÄ‚îÄ binary_search_coexistence  ‚Üí Main search algorithm"
            echo "  ‚îÇ   ‚îî‚îÄ‚îÄ run_coexistence        ‚Üí Individual temperature evaluation"
            echo "  ‚îÇ       ‚îú‚îÄ‚îÄ run_md             ‚Üí MD simulation execution"
            echo "  ‚îÇ       ‚îú‚îÄ‚îÄ calc_pressure      ‚Üí Pressure extraction"
            echo "  ‚îÇ       ‚îú‚îÄ‚îÄ density_profile    ‚Üí Phase analysis"
            echo "  ‚îÇ       ‚îú‚îÄ‚îÄ check_coexistence  ‚Üí Coexistence validation"
            echo "  ‚îÇ       ‚îî‚îÄ‚îÄ calc_volume        ‚Üí Volume calculation"
            echo "  ‚îî‚îÄ‚îÄ calc_volume                ‚Üí Final volume extraction"
            echo "Next:    TI pipeline (calc_vp_scan)"
            ;;
            
        "binary_search_coexistence")
            echo "üîç binary_search_coexistence - Temperature Search Algorithm"
            echo "========================================================"
            echo "Purpose: Implement binary search to find coexistence temperature"
            echo "Algorithm: Iterative temperature refinement within tolerance"
            echo "Parameters: TEMP_MIN, TEMP_MAX, TEMP_TOLERANCE"
            echo "Child: run_coexistence (for each temperature evaluation)"
            echo "Output: COEXISTENCE_TEMP (global variable)"
            ;;
            
        "run_coexistence")
            echo "üß™ run_coexistence - Single Temperature Evaluation"
            echo "==============================================="
            echo "Purpose: Evaluate coexistence at specific temperature"
            echo "Steps: Thermalization ‚Üí Melting ‚Üí Re-thermalization ‚Üí NVE sampling"
            echo "Child Functions: run_md, calc_pressure, density_profile, check_coexistence, calc_volume"
            echo "Output: Coexistence status (solid/liquid/coexistence)"
            ;;
        
        "calc_vp_scan")
            echo "1Ô∏è‚É£  calc_vp_scan - Volume-Pressure Calculation"
            echo "=============================================="
            echo "Purpose: Calculate pressure at different volumes for solid/liquid phases"
            echo "Usage:   calc_vp_scan [coex_vol] [num_atoms] [num_points] [output] [temp] [melt_temp] [sim_time] [element]"
            echo "Example: calc_vp_scan 23.5 432 5 VP.dat 980 4000 30000 Mg"
            echo "Inputs:  POSCAR.s (crystal structure), coex_results.dat"
            echo "Outputs: VP.dat (volume-pressure data)"
            echo "Next:    fit_eos_coex VP.dat"
            ;;
            
        "fit_eos_coex")
            echo "2Ô∏è‚É£  fit_eos_coex - EOS Fitting & Coexistence"
            echo "==========================================="
            echo "Purpose: Fit Birch-Murnaghan EOS and find coexistence volumes"
            echo "Usage:   fit_eos_coex [vp_file] [target_pressure] [plot] [vols_out] [element]"
            echo "Example: fit_eos_coex VP.dat 0.58 VP_plot.png vols.tmp Mg"
            echo "Inputs:  VP.dat (from calc_vp_scan)"
            echo "Outputs: vols.tmp (coexistence volumes), VP_plot.png"
            echo "Next:    sample_md_coex (reads vols.tmp automatically)"
            ;;
            
        "sample_md_coex")
            echo "3Ô∏è‚É£  sample_md_coex - MD Sampling at Coexistence"
            echo "=============================================="
            echo "Purpose: Run MD simulations at EOS-derived coexistence volumes"
            echo "Usage:   sample_md_coex [solid_vol] [liquid_vol] [cores] [temp] [target_p] [sim_time] [element]"
            echo "Example: sample_md_coex (auto-reads from vols.tmp)"
            echo "Inputs:  vols.tmp (from fit_eos_coex), POSCAR.s, POSCAR.l, INCAR"
            echo "Outputs: Sampling_*/XDATCAR.s, XDATCAR.l, CONTCAR.s, CONTCAR.l"
            echo "Next:    sample_ti_configs"
            ;;
            
        "sample_ti_configs")
            echo "4Ô∏è‚É£  sample_ti_configs - Thermodynamic Integration Sampling"
            echo "======================================================="
            echo "Purpose: Sample MD configurations for TI energy calculations"
            echo "Usage:   sample_ti_configs [mode] [num_atoms] [element] [cores] [start_frame] [spacing]"
            echo "Example: sample_ti_configs EAM 432 Mg 4 10 20"
            echo "Inputs:  XDATCAR.s/l (from sample_md_coex), POSCAR.s/l"
            echo "Outputs: s432EAM/, l432EAM/ (or DFT directories)"
            echo "Next:    Analyze OUTCAR.* files for thermodynamic integration"
            ;;
            
        "density_profile")
            echo "üî¨ density_profile - Phase Analysis Tool"
            echo "======================================"
            echo "Purpose: Analyze density profiles to determine phase state"
            echo "Usage:   Called automatically by run_coexistence"
            echo "Function: Distinguishes solid/liquid/coexistence phases"
            echo "Output: Phase classification for binary search"
            ;;
            
        "check_coexistence")
            echo "‚úÖ check_coexistence - Coexistence Validation"
            echo "==========================================="
            echo "Purpose: Validate coexistence state from simulation results"
            echo "Usage:   Called automatically by run_coexistence"
            echo "Criteria: Pressure stability, phase interface, density gradients"
            echo "Output: Boolean coexistence status"
            ;;
            
        "tools"|"utilities")
            echo "üõ†Ô∏è  UTILITY TOOLS REFERENCE"
            echo "==========================="
            echo ""
            echo "üìä CALCULATION TOOLS:"
            echo "  calc_pressure           ‚Üí Extract pressure from OUTCAR"
            echo "  calc_volume             ‚Üí Calculate volume from OUTCAR"
            echo "  calc_msd               ‚Üí Analyze diffusion properties"
            echo "  density_profile        ‚Üí Phase state analysis"
            echo "  check_coexistence      ‚Üí Coexistence validation"
            echo ""
            echo "üîß EXECUTION TOOLS:"
            echo "  run_md                 ‚Üí Execute MD simulations"
            echo "  main_exe               ‚Üí Coexistence search"
            echo "  binary_search_coexistence ‚Üí Search algorithm"
            echo "  run_coexistence        ‚Üí Temperature evaluation"
            echo ""
            echo "üìÑ FILE TOOLS:"
            echo "  convert_xdatcar        ‚Üí Convert trajectory formats"
            echo "  write_incar            ‚Üí Generate INCAR files"
            echo "  check_files            ‚Üí Validate input files"
            echo "  prep_structure         ‚Üí Prepare POSCAR files"
            echo ""
            echo "üèóÔ∏è  MANAGEMENT TOOLS:"
            echo "  setup_dirs             ‚Üí Create workflow directories"
            echo "  analyze_results        ‚Üí Parse calculation results"
            echo ""
            echo "üí° Use: show_pipeline_help [tool_name] for detailed usage"
            ;;
            
        "calc_volume")
            echo "üõ†Ô∏è  calc_volume - Volume Calculation (CORE)"
            echo "========================================"
            echo "Purpose: Extract volume from OUTCAR files"
            echo "Usage:   calc_volume [outcar_file]"
            echo "Example: calc_volume OUTCAR_980K"
            echo "Features: Direct volume extraction from VASP output"
            echo "Note:    Used in both coexistence search and final results"
            ;;
            
        "convert_xdatcar")
            echo "üõ†Ô∏è  convert_xdatcar - XDATCAR Format Conversion (UTILITY)"
            echo "======================================================"
            echo "Purpose: Convert md.x XDATCAR to VASP-compatible format"
            echo "Usage:   convert_xdatcar [remove_header] [input] [template] [output] [element] [start] [interval]"
            echo "Example: convert_xdatcar true XDATCAR.s CONTCAR.s XDATCAR_vasp.s Mg"
            echo "Note:    Optional tool for trajectory analysis"
            ;;
            
        "calc_msd")
            echo "üõ†Ô∏è  calc_msd - Mean Square Displacement Analysis (UTILITY)"
            echo "======================================================="
            echo "Purpose: Analyze diffusion properties from MD trajectories"
            echo "Usage:   calc_msd [xdatcar] [species] [output] [time_step] [step_skip]"
            echo "Example: calc_msd XDATCAR_vasp.s Mg solid_msd.png 2.0 5"
            echo "Note:    Optional analysis tool, not required for TI workflow"
            ;;
            
        "run_md")
            echo "üõ†Ô∏è  run_md - MD Simulation Runner (CORE/UTILITY)"
            echo "=============================================="
            echo "Purpose: Execute MD simulations with automatic cleanup"
            echo "Usage:   run_md [steps] [temp] [ensemble] [thermostat]"
            echo "Example: run_md 30000 980 NVT thermostat"
            echo "Features: Cleans CONTCAR velocities (crystal only), handles ensembles"
            echo "Note:    Used in both coexistence search and TI pipeline"
            ;;
            
        "calc_pressure")
            echo "üõ†Ô∏è  calc_pressure - Pressure Extraction (CORE/UTILITY)"
            echo "===================================================="
            echo "Purpose: Extract and calculate average pressure from OUTCAR"
            echo "Usage:   calc_pressure [outcar_file] [log_file]"
            echo "Example: calc_pressure OUTCAR pressure.log"
            echo "Features: Averages kinetic + potential, converts kBar ‚Üí GPa"
            echo "Note:    Used in both coexistence search and TI pipeline"
            ;;
            
        "write_incar")
            echo "üõ†Ô∏è  write_incar - INCAR Generator (CORE/UTILITY)"
            echo "=============================================="
            echo "Purpose: Generate VASP INCAR files with simulation parameters"
            echo "Usage:   write_incar [steps] [temp] [fixed_atoms] [thermostat]"
            echo "Example: write_incar 1500 980 '' thermostat"
            echo "Features: Template-based, EAM/DFT parameters, thermostat config"
            echo "Note:    Used throughout coexistence and TI workflows"
            ;;
            
        "check_files")
            echo "üõ†Ô∏è  check_files - File Validator (UTILITY)"
            echo "======================================="
            echo "Purpose: Validate required input files exist and are valid"
            echo "Usage:   check_files [file_list]"
            echo "Example: check_files 'POSCAR.coex POSCAR.s INCAR'"
            echo "Features: Existence checking, format validation, size verification"
            ;;
            
        "prep_structure")
            echo "üõ†Ô∏è  prep_structure - Structure Preparation (UTILITY)"
            echo "================================================"
            echo "Purpose: Prepare and modify POSCAR files for simulations"
            echo "Usage:   prep_structure [input] [output] [volume] [modifications]"
            echo "Example: prep_structure POSCAR POSCAR.s -10000 clean_velocities"
            echo "Features: Volume scaling, velocity cleaning, format standardization"
            ;;
            
        "setup_dirs")
            echo "üõ†Ô∏è  setup_dirs - Directory Manager (UTILITY)"
            echo "=========================================="
            echo "Purpose: Create and organize workflow directories"
            echo "Usage:   setup_dirs [workflow_type] [parameters]"
            echo "Example: setup_dirs COEX_TI '7064 432 Mg EAM'"
            echo "Features: Standard structure, file copying, permission setting"
            ;;
            
        "analyze_results")
            echo "üõ†Ô∏è  analyze_results - Results Parser (UTILITY)"
            echo "===========================================" 
            echo "Purpose: Parse and summarize calculation results"
            echo "Usage:   analyze_results [result_type] [input_files]"
            echo "Example: analyze_results COEX_TI 'coex_results.dat s432EAM l432EAM'"
            echo "Features: Energy extraction, statistical analysis, summary reporting"
            ;;
            
        "quick"|"summary")
            echo "‚ö° COMPLETE PIPELINE SUMMARY"
            echo "============================"
            echo "main_exe ‚Üí calc_vp_scan ‚Üí fit_eos_coex ‚Üí sample_md_coex ‚Üí sample_ti_configs"
            echo ""
            echo "üéØ ESSENTIAL WORKFLOW:"
            echo "  ./pipeline.sh coex              # Coexistence search (creates coex_results.dat)"
            echo "  ./pipeline.sh ti                # TI pipeline (uses coex_results.dat)"
            echo "  ./pipeline.sh both              # Complete pipeline (default)"
            echo ""
            echo "üìä MANUAL EXECUTION:"
            echo "  main_exe                        # Coexistence search (in Coexistence/)"
            echo "  calc_vp_scan                    # Generate VP data (in Free_energy/)"
            echo "  fit_eos_coex                    # Find coexistence volumes"
            echo "  sample_md_coex                  # MD at coexistence (auto-reads vols.tmp)"
            echo "  sample_ti_configs EAM           # Sample for TI calculations"
            echo ""
            echo "üõ†Ô∏è  UTILITY TOOLS:"
            echo "  convert_xdatcar, calc_msd, run_md, calc_pressure, calc_volume,"
            echo "  write_incar, check_files, prep_structure, setup_dirs, analyze_results,"
            echo "  density_profile, check_coexistence, binary_search_coexistence"
            ;;
            
        *)
            echo "‚ùì COMPLETE PIPELINE HELP SYSTEM"
            echo "================================"
            echo "Available sections:"
            echo "  show_pipeline_help flow         # Show complete pipeline flow"
            echo "  show_pipeline_help quick        # Complete workflow summary"
            echo "  show_pipeline_help tools        # All utility tools"
            echo "  show_pipeline_help [function]   # Detailed function help"
            echo ""
            echo "üî¨ COEXISTENCE PHASE:"
            echo "  main_exe, binary_search_coexistence, run_coexistence,"
            echo "  density_profile, check_coexistence"
            echo ""
            echo "üß™ TI PHASE:"
            echo "  calc_vp_scan, fit_eos_coex, sample_md_coex, sample_ti_configs"
            echo ""
            echo "üõ†Ô∏è  SHARED UTILITIES:"
            echo "  run_md, calc_pressure, calc_volume, write_incar, convert_xdatcar,"
            echo "  calc_msd, check_files, prep_structure, setup_dirs, analyze_results"
            echo ""
            echo "üöÄ PIPELINE MODES:"
            echo "  ./pipeline.sh coex|ti|both"
            ;;
    esac
}


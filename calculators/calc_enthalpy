#!/bin/bash -l
#===============================================================================
# Function      : calc_enthalpy
# Required files: POTCAR (from $HOME/POTs/Mg/POTCAR), vasp_std executable
# Purpose       : Calculate enthalpy and pressure for a crystal phase at specified volume
# Usage         : calc_enthalpy [volume] [kpoints_mesh] [output_file] [phase] [natoms] [temp]
# Example usage : calc_enthalpy 42.5 "8 8 6" PH_BCC.dat "BCC" 1 300
#                : calc_enthalpy 41.0 "8 8 8" PH_HCP.dat "HCP" 2 500
# Last Update   : 2025-07-24-temperature-parameter
#===============================================================================

# Global POSCAR templates for different phases
POSCAR_BCC="Mg BCC
-VOL
0.5 0.5 0.5
0.5 -0.5 0.5
0.5 0.5 -0.5
Mg
1
Direct
0.0 0.0 0.0"

POSCAR_HCP="Mg HCP
-VOL
1.0 0.0 0.0
-0.5 0.866025 0.0
0.0 0.0 1.633
Mg
2
Direct
0.333333 0.666667 0.25
0.666667 0.333333 0.75"

# Global defaults


calc_enthalpy() {
    local VOLUME="${1:-41.0}"
    local KPOINTS_MESH="${2:-8 8 8}"
    local OUTPUT="${3:-PH.dat}"
    local PHASE="${4:-BCC}"
    local NATOMS="${5:-1}"
    local TEMP="${6:-300}"
    local TEMP_ELEC=$(awk "BEGIN {printf \"%.6f\", $TEMP * 8.617e-5}")
    local WORKDIR="Phase_$PHASE"

    # Select appropriate POSCAR template based on phase
    local POSCAR_CONTENT
    if [[ "$PHASE" == "BCC" ]]; then
        POSCAR_CONTENT="$POSCAR_BCC"
    elif [[ "$PHASE" == "HCP" ]]; then
        POSCAR_CONTENT="$POSCAR_HCP"
    else
        echo "‚ùå [ERROR] Unknown phase: $PHASE (supported: BCC, HCP)"
        return 1
    fi

    echo "üî¨ ============================================"
    echo "üöÄ Running calc_enthalpy for phase: $PHASE"
    echo "üì¶ Volume = $VOLUME √Ö¬≥"
    echo "üî¢ K-points = $KPOINTS_MESH"
    echo "‚öõÔ∏è  Number of atoms = $NATOMS"
    echo "üå°Ô∏è  Temperature = $TEMP K (SIGMA = $TEMP_ELEC eV)"
    echo "üìÑ Output file = $OUTPUT"
    echo "üìÅ Working directory = $WORKDIR"
    echo "============================================ üî¨"

    mkdir -p "$WORKDIR" && cd "$WORKDIR" || exit 1

    # Create POSCAR - replace VOL placeholder with actual volume
    echo "üìù Creating POSCAR file..."
    echo "$POSCAR_CONTENT" | sed "s/VOL/$VOLUME/" > POSCAR

    # Create KPOINTS file
    echo "üéØ Creating KPOINTS file..."
    cat > KPOINTS << EOF
KPOINTS
0
Monkhorst-Pack
$KPOINTS_MESH
0 0 0
EOF

    # Create INCAR file
    echo "‚öôÔ∏è  Creating INCAR file..."
    cat > INCAR << EOF
ENCUT = 520
LCHARG = .FALSE.
LWAVE = .FALSE.
IBRION = 2
ISIF = 2
ISMEAR = 1
SIGMA = $TEMP_ELEC
NSW = 500
POTIM = 0.5
EOF

    # Copy POTCAR
    echo "üìã Copying POTCAR..."
    cp "$HOME/POTs/Mg/POTCAR" .

    echo "‚ö° Running VASP calculation..."
    srun vasp_std > vasp.out 2>&1

    # Extract and save results
    # Extract and save result
    if [[ -f OUTCAR ]]; then
        local P_kbar=$(grep "external pressure" OUTCAR | tail -1 | awk '{print $4}')
        local E_total=$(grep "free  energy" OUTCAR | tail -1 | awk '{print $5}')
        if [[ -n "$P_kbar" && -n "$E_total" && "$P_kbar" != "" && "$E_total" != "" ]]; then
            # Convert extensive quantities to per-atom basis first
            local E_per_atom=$(awk "BEGIN{printf \"%.8f\", $E_total / $NATOMS}")
            local V_per_atom=$(awk "BEGIN{printf \"%.6f\", $VOLUME / $NATOMS}")
            local P_gpa=$(awk "BEGIN{printf \"%.6f\", $P_kbar * 0.1}")
            
            # Calculate enthalpy per atom: H = U + PV (all per atom)
            local H_per_atom=$(awk "BEGIN{printf \"%.8f\", $E_per_atom + $P_kbar * 0.0000006241509 * $V_per_atom}")
            
            # Output: Energy/atom Pressure(GPa) Volume/atom Enthalpy/atom
            echo "$E_per_atom $P_gpa $V_per_atom $H_per_atom" >> "../$OUTPUT"
            echo "‚úÖ [DONE] E = $E_per_atom eV/atom, P = $P_gpa GPa, V = $V_per_atom √Ö¬≥/atom, H = $H_per_atom eV/atom ‚Üí saved to $OUTPUT"
            
        else
            echo "N/A N/A N/A N/A" >> "../$OUTPUT"
            echo "‚ùå [ERROR] Could not extract pressure or energy from OUTCAR"
        fi
    else
        echo "N/A N/A N/A N/A" >> "../$OUTPUT"
        echo "‚ùå [ERROR] OUTCAR not found ‚Äî calculation failed."
    fi

    cd ..
}

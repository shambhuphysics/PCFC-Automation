#!/bin/bash -l
#===============================================================================
# Function      : main_exe
# Required files: POSCAR.coex
# Purpose       : Binary search for coexistence with integrated data export
# Child Function: run_coexistence, calc_temperature, calc_pressure, calc_volume
# Run individually: main_exe
# Last Update   : 2025-11-17
#===============================================================================

main_exe() {
    # Search parameters
    local low="${TEMP_MIN:-970}"
    local high="${TEMP_MAX:-1000}"             
    local temp_tolerance="${TEMP_TOLERANCE:-10}"
    local max_iterations="${MAX_ITERATIONS:-15}"
    
    display_banner
    # Setup
    cp POSCAR.coex POSCAR || { echo "âŒ ERROR: POSCAR.coex not found" >&2; return 1; }

    # Binary search
    echo "ğŸ” Binary search range: $low - $high K (tolerance: $temp_tolerance K)"
    echo "================================================="
    
    local iteration=1
    local search_success=0
    
    while [[ $iteration -le $max_iterations ]]; do
        local mid=$(( low + (high - low) / 2 ))
        local range=$((high - low))

        echo "ğŸ”¬ Iteration $iteration: Testing $mid K (range: $low-$high K)"

        # Check convergence
        if [[ $range -le $temp_tolerance ]]; then
            echo "âŒ Range narrowed to ${range}K - coexistence not found" >&2
            return 1
        fi

        # Run coexistence check
        local state
        state=$(run_coexistence "$mid" "false" | xargs) || { 
            echo "âŒ ERROR: Failed to evaluate $mid K" >&2
            return 1
        }
        echo "ğŸ“Š Result: $state"

        case "$state" in
            "Coexistence")
                echo -e "\033[1;32mğŸ¯ SUCCESS: Found coexistence at $mid K!\033[0m"
                
                echo "ğŸ”¬ Performing refinement..."
                local refined_state
                refined_state=$(run_coexistence "$mid" "true")
                echo "ğŸ“ˆ Refined result: $refined_state"

                case "$refined_state" in
                    "Coexistence")
                        echo -e "\033[1;32mâœ… Coexistence confirmed!\033[0m"
                        COEXISTENCE_TEMP=$mid
                        search_success=1
                        break
                        ;;
                    "Solid-only")
                        echo "ğŸ§Š REFINED â†’ SOLID -> need HIGHER â¬†ï¸ temperature"
                        low=$mid
                        ;;
                    "Liquid-only")
                        echo "ğŸ’§ REFINED â†’ LIQUID -> need LOWER â¬‡ï¸ temperature"
                        high=$mid
                        ;;
                    "Crashed")
                        echo "âš ï¸ WARNING: Refinement crashed - continuing search ğŸ”"
                        ;;
                esac
                ;;
            "Solid-only")
                echo "ğŸ§Š SOLID -> need HIGHER â¬†ï¸ temperature"
                low=$mid
                ;;
            "Liquid-only")
                echo "ğŸ’§ LIQUID -> need LOWER â¬‡ï¸ temperature"
                high=$mid
                ;;
            "Crashed")
                echo "âš ï¸ WARNING: Simulation crashed at $mid K - continuing ğŸ”"
                ;;
        esac

        echo "ğŸ“ New range: $low-$high K"
        iteration=$((iteration + 1))
        echo "-------------------------------------------------"
    done

    # Exit if failed
    if [[ $search_success -eq 0 ]]; then
        echo "âŒ Maximum iterations reached without finding coexistence" >&2
        return 1
    fi

    # Export coexistence data
    echo ""
    echo "ğŸ“¤ Exporting coexistence data..."
    
    local TEMP=$(calc_temperature OSZICAR | awk '{print $2}')
    local PRESS=$(calc_pressure OUTCAR | awk '{print $2}')
    local VOL=$(calc_volume OUTCAR)
    local vol_per_atom=$(echo "scale=6; $VOL / ${COEX_ATOMS:-1}" | bc -l)
    
    #Marking the coexistence data
    calc_atom CONTCAR "density_${TEMP}K.dat" 400 "density_${TEMP}K.png"  >&2

    
    cat > ../coex_results.dat << EOF
COEX_TEMP=$TEMP
COEX_PRESS=$PRESS
COEX_VOL=$vol_per_atom
EOF
    
    echo "âœ… Exported: V=${VOL}Ã…Â³ (${vol_per_atom}Ã…Â³/atom), P=${PRESS}GPa, T=${TEMP}K"

    # Success summary
    echo ""
    echo -e "\033[1;32m============================================================\033[0m"
    echo -e "\033[1;32m              SEARCH COMPLETED SUCCESSFULLY\033[0m"
    echo -e "\033[1;32m============================================================\033[0m"
    echo -e "\033[1;32mCoexistence Temperature: $TEMP K\033[0m"
    echo -e "\033[1;32mPressure: $PRESS GPa\033[0m"
    echo -e "\033[1;32mVolume: $VOL Ã…Â³ (${vol_per_atom} Ã…Â³/atom)\033[0m"
    echo -e "\033[1;32m============================================================\033[0m"
    echo ""
    echo "âœ… Results saved to ../coex_results.dat"
    
    return 0
}

#!/bin/bash -l
#===============================================================================
# Function      : binary_search_coexistence
# Required files: -- (uses run_coexistence which requires POSCAR.coex)
# Purpose       : Performs binary search to find solid-liquid coexistence temperature
# Child Function: run_coexistence
# Default parameters: low=TEMP_MIN (970), high=TEMP_MAX (4000), temp_tolerance=TEMP_TOLERANCE (10), max_iterations=MAX_ITERATIONS (15)
# Run individually: binary_search_coexistence
# Example usage  : binary_search_coexistence
# Last Update   : 2025-07-19/crashed-->repeat-->even in long run
#===============================================================================

binary_search_coexistence() {
    local low="${TEMP_MIN:-970}"
    local high="${TEMP_MAX:-1000}"             
    local temp_tolerance="${TEMP_TOLERANCE:-10}"
    local max_iterations="${MAX_ITERATIONS:-15}"

    echo "ğŸ” Binary search range: $low - $high K (tolerance: $temp_tolerance K)"
    echo "================================================="

    local iteration=1
    while [[ $iteration -le $max_iterations ]]; do
        local mid=$(( (low + high) / 2 ))
        local range=$((high - low))

        echo "ğŸ”¬ Iteration $iteration: Testing $mid K (range: $low-$high K)"

        local state
        state=$(run_coexistence "$mid" "false" | xargs) || { echo "âŒ ERROR: Failed to evaluate $mid K"; return 1; }
        echo "ğŸ“Š Result: $state"

        # Update search range
        case "$state" in
            "Coexistence")
                echo -e "\033[1;32mğŸ¯ SUCCESS:âœ… Found coexistence at $mid K!\033[0m"
                COEXISTENCE_TEMP=$mid
                SEARCH_SUCCESS=1

                echo "ğŸ”¬ Performing refinement..."
                local refined_state
                refined_state=$(run_coexistence "$mid" "true")  # Rerun longer to verify Coexistence.

                echo "ğŸ“ˆ Refined result: $refined_state"

                case "$refined_state" in
                    "Coexistence")
                        echo -e "\033[1;32mâœ… Coexistence confirmed!\033[0m"
                        return 0
                        ;;
                    "Solid-only")
                        echo "ğŸ§Š REFINED â†’ SOLID -> need HIGHER â¬†ï¸ temperature"
                        low=$mid
                        ;;
                    "Liquid-only")
                        echo "ğŸ’§ REFINED â†’ LIQUID LIQUID -> need LOWER â¬‡ï¸ temperature"
                        high=$mid
                        ;;
                    "Crashed")
                        echo "âš ï¸ WARNING!!: Refinement crashed at $mid K - retrying refinement ğŸ”"
                        mid=$(( (low + high) / 2 )) # Re-run same iteration without updating range
                        ;;
                esac
                ;;
            "Solid-only")
                echo "ğŸ§Š SOLID -> need HIGHER â¬†ï¸ temperature"
                low=$mid
                ;;
            "Liquid-only")
                echo "ğŸ’§ LIQUID -> need LOWER â¬‡ï¸ temperature"
                high=$mid
                ;;
            "Crashed")
                echo "âš ï¸ WARNING!!: Simulation crashed at $mid K - retrying ğŸ”"
                mid=$(( (low + high) / 2 ))  # Re-run same iteration without updating range
                ;;
        esac

        echo "ğŸ“ New range: $low-$high K"

        # Check convergence
        if [[ $range -le $temp_tolerance ]]; then
        echo "âš ï¸ Range narrowed to ${range}K - coexistence not found ğŸ”"
        return 1
        fi

        iteration=$((iteration + 1))
        echo "-------------------------------------------------"
    done

    echo "â° Maximum iterations reached"
    COEXISTENCE_TEMP=$(( (low + high) / 2 ))
    SEARCH_SUCCESS=0
    return 1
}
